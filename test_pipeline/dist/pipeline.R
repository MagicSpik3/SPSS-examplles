setwd("/home/jonny/git/SPSS-examplles/test_pipeline/dist")
# Auto-Generated ETL Script
# Generated by: V&V Compiler
# Dialect: Tidyverse

library(tidyverse)
library(lubridate)

# Op: op_001_load
source_regions.csv <- read_csv("regions.csv")

# Op: op_002_exec
ds_001_materialized <- source_regions.csv

# Op: op_003_sort
ds_002_sorted <- ds_001_materialized %>% arrange(region_code)

# Op: op_004_save
write_csv(ds_002_sorted, "temp_regions.sav")

# Op: op_005_exec
ds_003_materialized <- ds_002_sorted

# Op: op_006_load
source_people.csv <- read_csv("people.csv")

# Op: op_007_exec
ds_004_materialized <- source_people.csv

# Op: batch_op_008_compute
ds_012_derived <- ds_004_materialized %>%
  mutate(
    dor_num = NUMBER ( dor , F8.0 ),
    dod_num = NUMBER ( dod , F8.0 ),
    dor_y = TRUNC ( dor_num / 10000 ),
    dor_m = TRUNC ( ( dor_num - dor_y * 10000 ) / 100 ),
    dor_d = dor_num - dor_y * 10000 - dor_m * 100,
    dod_y = TRUNC ( dod_num / 10000 ),
    dod_m = TRUNC ( ( dod_num - dod_y * 10000 ) / 100 ),
    dod_d = dod_num - dod_y * 10000 - dod_m * 100
  )

# Op: op_016_exec
ds_013_materialized <- ds_012_derived

# Op: batch_op_017_compute
ds_017_derived <- ds_013_materialized %>%
  mutate(
    date_reg = DATE.MDY ( dor_m , dor_d , dor_y ),
    date_death = DATE.MDY ( dod_m , dod_d , dod_y ),
    delay_days = ( date_death - date_reg ) / 86400
  )

# Op: op_021_exec
ds_018_materialized <- ds_017_derived

# Op: op_022_filter
ds_019_filtered <- ds_018_materialized %>% filter(delay_days >= 0)

# Op: op_023_exec
ds_020_materialized <- ds_019_filtered

# Op: op_024_sort
ds_021_sorted <- ds_020_materialized %>% arrange(region_code)

# Op: op_025_join
ds_022_joined <- ds_021_sorted %>% inner_join(file_temp_regions.sav)

# Op: op_026_exec
ds_023_materialized <- ds_022_joined

# Op: batch_op_028_compute_if
ds_027_derived <- ds_023_materialized %>%
  mutate(
    income_band = 'LOW',
    income_band = 'MEDIUM',
    income_band = 'HIGH'
  )

# Op: op_031_exec
ds_028_materialized <- ds_027_derived

# Op: op_032_aggregate
ds_029_agg_active <- ds_028_materialized %>%
  group_by(region_name, income_band) %>%
  summarise(TOTAL_DEATHS = N, AVG_DELAY = MEAN ( delay_days , na.rm = TRUE))

# Op: op_033_exec
ds_030_materialized <- ds_029_agg_active

# Op: op_034_save
write_csv(ds_030_materialized, "final_output.csv")
